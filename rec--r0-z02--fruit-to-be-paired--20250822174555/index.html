<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="../../favicon.ico">
    <!-- vConsole 在 Phaser 之前加载 -->
    <script>
        // 检查是否需要启用 vConsole
        if (location.search.indexOf('console') > -1) {
            document.write('<script src="../../template/vconsole.min.js"><\/script>');
            document.write('<script>try { new VConsole(); console.log("vConsole 已启动"); } catch(e) { console.error("vConsole 初始化失败:", e); }<\/script>');
        }
    </script>

    <!-- 启动覆盖层控制说明 -->
    <!-- 
    URL参数控制：
    - ?console - 启用移动端调试控制台
    - ?no-overlay - 隐藏启动覆盖层（直接启动游戏）
    - 组合使用：?console&no-overlay - 启用调试并隐藏覆盖层
    
    使用示例：
    1. 正常访问：game.html（显示启动覆盖层）
    2. 启用调试：game.html?console
    3. 隐藏覆盖层：game.html?no-overlay（直接启动游戏）
    4. 同时启用：game.html?console&no-overlay
    
    说明：
    - 默认情况下显示启动覆盖层，用户需要点击"开始体验"按钮
    - 使用 ?no-overlay 参数可以跳过覆盖层，直接启动游戏
    -->
    <script src="./template/phaser.min.js"></script>
    <title>rec--r0-z02--no8-war - 定制互动题</title>
    <style>
        /* 设置根元素字体大小 */
        :root {
            font-size: 16px;
        }

        @media screen and (max-width: 768px) {
            :root {
                font-size: 3.5vw;
            }
        }

        body {
            margin: 0;
            background: #000;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }

        #app {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            margin-left: 0 !important;
            margin-top: 0 !important;
        }

        /* 加载指示器 */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.125rem;
            z-index: 999;
        }

        /* 悬浮按钮样式 */
        .float-button {
            position: fixed;
            top: 2vh;
            left: 2vh;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            font-size: 1.25rem;
            cursor: pointer;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .float-button:hover {
            background-color: rgba(0, 0, 0, 0.9);
            transform: translateY(-1px);
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.4);
        }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1001;
            padding: 2vh;
            box-sizing: border-box;
        }

        .modal.show {
            display: flex !important;
        }

        .modal-content {
            background-color: white;
            padding: 2rem 2.5rem;
            border-radius: 1.5rem;
            max-width: 28rem;
            width: 100%;
            text-align: center;
            position: absolute;
            top: 8vh;
            left: 2vh;
            box-sizing: border-box;
            box-shadow: 0 0.5rem 2rem rgba(0, 0, 0, 0.25);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-close {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            cursor: pointer;
            font-size: 2.5rem;
            color: #666;
            width: 3.5rem;
            height: 3.5rem;
            line-height: 3.5rem;
            text-align: center;
        }

        .modal h3 {
            margin: 0 0 2.5rem;
            font-size: 3rem;
            color: #333;
            font-weight: 500;
        }

        .browser-tip-image {
            width: 200px;
            margin: 10px auto;
            display: block;
        }

        /* 浏览器图标样式 */
        .browser-icon {
            width: 8rem;
            height: 8rem;
            margin: 2.5rem auto;
            display: block;
        }

        .browser-icon path {
            fill: #3080E9;
        }

        /* 菜单图标样式 */
        .menu-icon {
            width: 2.5rem;
            height: 2.5rem;
            vertical-align: middle;
            margin: 0 0.75rem;
            display: inline-block;
        }

        .menu-icon path {
            fill: #58595B;
        }

        /* 提示步骤样式 */
        .tip-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem 0;
            font-size: 2rem;
            color: #333;
            flex-wrap: wrap;
            gap: 1rem;
            line-height: 1.6;
        }

        .tip-steps .step {
            margin: 0 0.5rem;
        }

        /* 游戏启动覆盖层样式 */
        .game-start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        .game-start-overlay.hide {
            opacity: 0;
            pointer-events: none;
        }

        .start-content {
            text-align: center;
            color: white;
            padding: 3rem;
            border-radius: 2rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .start-icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        .start-content h2 {
            font-size: 2.5rem;
            margin: 0 0 1rem;
            font-weight: 500;
        }

        .start-content p {
            font-size: 1.2rem;
            margin: 0 0 2.5rem;
            opacity: 0.9;
        }

        .start-button {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.3rem;
            border-radius: 3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-weight: 600;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .start-button:active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .start-content {
                padding: 2rem;
                margin: 1rem;
            }

            .start-icon {
                font-size: 4rem;
            }

            .start-content h2 {
                font-size: 2rem;
            }

            .start-content p {
                font-size: 1rem;
            }

            .start-button {
                font-size: 1.1rem;
                padding: 0.8rem 2rem;
            }
        }

        /* 移动端适配 */
        @media screen and (max-width: 768px) {
            .float-button {
                top: 2vh;
                left: 2vh;
                padding: 1rem 1.5rem;
                font-size: 1.5rem;
                border-radius: 2rem;
            }

            .modal-content {
                padding: 2.5rem 2rem;
                max-width: calc(100vw - 4vh);
                top: 10vh;
                left: 2vh;
                right: 2vh;
                width: auto;
            }

            .modal h3 {
                font-size: 2.5rem;
                margin: 0 0 2rem;
            }

            .tip-steps {
                font-size: 1.75rem;
                margin: 1.5rem 0;
                gap: 1rem;
            }

            .browser-icon {
                width: 7rem;
                height: 7rem;
                margin: 2rem auto;
            }

            .menu-icon {
                width: 2.5rem;
                height: 2.5rem;
                margin: 0 0.5rem;
            }

            .modal-close {
                font-size: 2.5rem;
                width: 3rem;
                height: 3rem;
                line-height: 3rem;
                right: 1rem;
                top: 1rem;
            }
        }

        /* 中等屏幕适配 */
        @media screen and (max-width: 480px) {
            .float-button {
                padding: 0.875rem 1.375rem;
                font-size: 1.375rem;
            }

            .modal-content {
                max-width: calc(100vw - 3vh);
                top: 9vh;
                left: 1.5vh;
                right: 1.5vh;
            }

            .modal h3 {
                font-size: 2.25rem;
            }

            .tip-steps {
                font-size: 1.625rem;
            }

            .browser-icon {
                width: 6.5rem;
                height: 6.5rem;
            }

            .menu-icon {
                width: 2.25rem;
                height: 2.25rem;
            }
        }

        /* 超小屏幕适配 */
        @media screen and (max-width: 320px) {
            :root {
                font-size: 4vw;
            }

            .float-button {
                padding: 0.75rem 1.25rem;
                font-size: 1.25rem;
                top: 1.5vh;
                left: 1.5vh;
            }

            .modal-content {
                padding: 2rem 1.5rem;
                top: 12vh;
                left: 1.5vh;
                right: 1.5vh;
                max-width: calc(100vw - 3vh);
            }

            .modal h3 {
                font-size: 2rem;
                margin: 0 0 1.5rem;
            }

            .tip-steps {
                font-size: 1.5rem;
                margin: 1.25rem 0;
                gap: 0.75rem;
            }

            .browser-icon {
                width: 6rem;
                height: 6rem;
                margin: 1.5rem auto;
            }

            .menu-icon {
                width: 2rem;
                height: 2rem;
                margin: 0 0.25rem;
            }

            .modal-close {
                font-size: 2rem;
                width: 2.5rem;
                height: 2.5rem;
                line-height: 2.5rem;
                right: 0.75rem;
                top: 0.75rem;
            }
        }
    </style>
</head>

<body>
    <!-- 悬浮按钮 - 只在iOS微信内显示 -->
    <div class="float-button" id="helpButton" onclick="showModal()" style="display: none;">无法打开？</div>

    <!-- 弹窗 - 只在iOS微信内显示 -->
    <div class="modal" id="helpModal" onclick="hideModal(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="hideModal(event)">×</span>
            <h3>无法正常打开？</h3>
            <div class="tip-steps">
                <span class="step">点击右上角</span>
                <svg class="menu-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M188.2 507.2m-91.5 0a91.5 91.5 0 1 0 183 0 91.5 91.5 0 1 0-183 0Z"></path>
                    <path d="M516.2 507.2m-91.5 0a91.5 91.5 0 1 0 183 0 91.5 91.5 0 1 0-183 0Z"></path>
                    <path d="M836.5 507.2m-91.5 0a91.5 91.5 0 1 0 183 0 91.5 91.5 0 1 0-183 0Z"></path>
                </svg>
                <span class="step">选择「在浏览器中打开」</span>
            </div>
            <svg class="browser-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M512 885.76a392.2944 392.2944 0 1 1 392.192-392.192A392.6016 392.6016 0 0 1 512 885.76z m0-702.5664A310.3744 310.3744 0 1 0 822.6816 493.568 310.6816 310.6816 0 0 0 512 183.1936z">
                </path>
                <path
                    d="M978.432 263.8848c-22.9376-46.6944-127.2832-36.5568-193.7408-11.3664l29.0816 76.5952c4.3008-1.6384 8.6016-3.1744 12.8-4.5056l-8.704 5.4272c-76.0832 47.0016-187.0848 107.1104-304.64 165.0688S280.2688 604.16 196.7104 636.1088l-2.1504 0.8192-30.72-49.5616C91.136 632.2176 22.4256 674.7136 46.3872 723.1488c9.216 18.8416 26.3168 26.112 48.3328 26.112 34.816 0 81.92-18.0224 131.072-36.5568 87.1424-33.0752 202.0352-84.1728 323.584-144.0768S781.6192 448.7168 860.8768 399.36c72.8064-44.544 141.5168-87.04 117.5552-135.4752zM125.7472 675.0208l24.064-26.624 11.3664 26.624z m739.7376-350.5152a98.304 98.304 0 0 0-18.2272-32.4608 152.1664 152.1664 0 0 1 57.0368-10.24 115.5072 115.5072 0 0 1-38.8096 42.7008z">
                </path>
            </svg>
        </div>
    </div>

    <!-- 加载指示器 -->
    <div class="loading" id="loading">图纸加载中...</div>

    <!-- 游戏启动覆盖层 -->
    <div class="game-start-overlay" id="gameStartOverlay">
        <div class="start-content">
            <div class="start-icon">🚀</div>
            <h2>准备开始体验</h2>
            <p>点击下方按钮开始互动学习</p>
            <button class="start-button" id="startGameBtn">✨ 开始体验</button>
        </div>
    </div>

    <div id="app">
        <div id="game-container"></div>
    </div>

    <script src="./javascript/index.js"></script>
    <script>
        // 检测是否需要显示启动覆盖层
        function shouldShowStartOverlay() {
            // 检查URL参数，如果指定 ?no-overlay 则隐藏启动覆盖层
            // 默认情况下显示启动覆盖层
            return location.search.indexOf('no-overlay') === -1;
        }

        // 用户交互状态
        let userInteracted = false;
        let gameInitialized = false;

        // 初始化游戏
        function initializeGame() {
            if (gameInitialized) return;

            console.log('🎮 初始化游戏...');
            gameInitialized = true;

            // 隐藏加载指示器
            setTimeout(() => {
                const loading = document.getElementById('loading');
                if (loading) loading.style.display = 'none';
            }, 1000);

            // 游戏配置
            if (window['::::LIVE_CONTEXT::::']) {
                const config = {
                    width: 1920,
                    height: 1440,
                    scale: {
                        mode: Phaser.Scale.FIT,
                        autoCenter: Phaser.Scale.CENTER_BOTH
                    },
                    physics: {
                        default: 'arcade'
                    },
                    dom: {
                        createContainer: true
                    },
                    parent: 'game-container',
                    transparent: false
                };
                const game = new Phaser.Game(config);
                window.addScene(game, '../../rec--r0-z02--fruit-to-be-paired--20250822174555/', { logger: console.log });
                setTimeout(() => {
                    game.events.emit('interactionStart')
                }, 500)
            }

            if (window['::::REC_CONTEXT::::']) {
                const config = {
                    width: 1920,
                    height: 1080,
                    scale: {
                        mode: Phaser.Scale.FIT,
                        autoCenter: Phaser.Scale.CENTER_BOTH
                    },
                    physics: {
                        default: 'arcade'
                    },
                    dom: {
                        createContainer: true
                    },
                    parent: 'game-container',
                    transparent: false
                };
                const game = new Phaser.Game(config);
                window.addScene(game, '../../rec--r0-z02--fruit-to-be-paired--20250822174555/', { logger: console.log });
                setTimeout(() => {
                    game.events.emit('questionStart')
                }, 500)
            }

            // 通用游戏配置（如果没有特定上下文）
            if (!window['::::LIVE_CONTEXT::::'] && !window['::::REC_CONTEXT::::']) {
                const config = {
                    width: 1920,
                    height: 1440,
                    scale: {
                        mode: Phaser.Scale.FIT,
                        autoCenter: Phaser.Scale.CENTER_BOTH
                    },
                    physics: {
                        default: 'arcade'
                    },
                    dom: {
                        createContainer: true
                    },
                    parent: 'game-container',
                    transparent: false
                };
                const game = new Phaser.Game(config);
                window.addScene(game, '../../rec--r0-z02--fruit-to-be-paired--20250822174555/', { logger: console.log });
                setTimeout(() => {
                    game.events.emit('interactionStart')
                }, 500)
            }
        }

        // 启动游戏函数
        function startGame() {
            console.log('🚀 用户点击启动游戏');
            userInteracted = true;

            // 隐藏启动覆盖层
            const overlay = document.getElementById('gameStartOverlay');
            if (overlay) {
                overlay.classList.add('hide');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 500);
            }

            // 初始化游戏
            initializeGame();
        }

        // 页面加载完成后的处理
        document.addEventListener('DOMContentLoaded', function () {
            const overlay = document.getElementById('gameStartOverlay');
            const startBtn = document.getElementById('startGameBtn');

            // 绑定启动按钮事件
            if (startBtn) {
                startBtn.addEventListener('click', startGame);
            }

            // 检测是否需要显示启动覆盖层
            if (shouldShowStartOverlay()) {
                console.log('🔍 需要显示启动覆盖层');
                // 显示启动覆盖层
                if (overlay) {
                    overlay.style.display = 'flex';
                }
            } else {
                console.log('📱 不需要显示启动覆盖层，直接启动游戏');
                // 直接启动游戏
                userInteracted = true;
                if (overlay) {
                    overlay.style.display = 'none';
                }
                initializeGame();
            }
        });

        // 备用方案：监听任何用户交互
        function handleUserInteraction() {
            if (!userInteracted && gameInitialized) {
                console.log('💡 检测到用户交互，触发游戏事件');
                userInteracted = true;

                // 尝试重新触发游戏事件
                setTimeout(() => {
                    if (window.game && window.game.events) {
                        if (window['::::LIVE_CONTEXT::::']) {
                            window.game.events.emit('interactionStart');
                        } else if (window['::::REC_CONTEXT::::']) {
                            window.game.events.emit('questionStart');
                        } else {
                            window.game.events.emit('interactionStart');
                        }
                    }
                }, 100);
            }
        }

        // 监听各种用户交互事件
        ['click', 'touchstart', 'keydown'].forEach(event => {
            document.addEventListener(event, handleUserInteraction, { once: true });
        });
    </script>

    <!-- iOS微信检测和弹窗控制脚本 -->
    <script>
        // 检测是否为iOS设备
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        // 检测是否为微信内置浏览器
        function isWeixinBrowser() {
            var isWeixin = false;

            // 首先检查User Agent
            if (/MicroMessenger/i.test(navigator.userAgent)) {
                // 然后检查WeixinJSBridge
                if (typeof WeixinJSBridge == "object" && typeof WeixinJSBridge.invoke == "function") {
                    isWeixin = true;
                } else {
                    // 监听WeixinJSBridge准备就绪事件
                    if (document.addEventListener) {
                        document.addEventListener("WeixinJSBridgeReady", function () {
                            isWeixin = true;
                            checkAndShowHelpButton();
                        }, false);
                    } else if (document.attachEvent) {
                        document.attachEvent("WeixinJSBridgeReady", function () {
                            isWeixin = true;
                            checkAndShowHelpButton();
                        });
                        document.attachEvent("onWeixinJSBridgeReady", function () {
                            isWeixin = true;
                            checkAndShowHelpButton();
                        });
                    }
                }
            }

            return isWeixin;
        }

        // 检查并显示帮助按钮
        function checkAndShowHelpButton() {
            const helpButton = document.getElementById('helpButton');
            const helpModal = document.getElementById('helpModal');

            if (isIOS() && isWeixinBrowser()) {
                // 在iOS微信环境中显示帮助按钮
                if (helpButton) {
                    helpButton.style.display = 'block';
                }
                // 确保弹窗处于可用状态但默认隐藏
                if (helpModal) {
                    helpModal.classList.remove('show');
                }

                console.log('检测到iOS微信环境，显示帮助按钮');
            } else {
                // 在其他环境中隐藏帮助按钮和弹窗
                if (helpButton) {
                    helpButton.style.display = 'none';
                }
                if (helpModal) {
                    helpModal.classList.remove('show');
                }

                console.log('非iOS微信环境，隐藏帮助功能');
            }
        }

        // 显示弹窗
        function showModal() {
            console.log('showModal');
            const modal = document.getElementById('helpModal');
            if (modal) {
                modal.classList.add('show');
            }
        }

        // 隐藏弹窗
        function hideModal(event) {
            console.log('hideModal');
            const modal = document.getElementById('helpModal');
            const modalContent = modal.querySelector('.modal-content');

            // 如果点击的是模态框外部或关闭按钮，则关闭弹窗
            if (event.target === modal || event.target.className === 'modal-close') {
                modal.classList.remove('show');
            }
        }

        // 页面加载完成后进行检测
        window.addEventListener('load', function () {
            // 延迟检测，确保微信环境完全初始化
            setTimeout(function () {
                checkAndShowHelpButton();
            }, 500);
        });

        // 立即检测一次（如果WeixinJSBridge已经准备好）
        checkAndShowHelpButton();
    </script>
</body>

</html>